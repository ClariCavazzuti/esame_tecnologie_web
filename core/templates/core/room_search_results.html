<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Risultati della Ricerca Camere</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <h1>Risultati della Ricerca Camere</h1>

    <form id="prenotazione-form" method="POST">
        {% csrf_token %}
        {% if available_rooms %}
            <ul>
                {% for camera in available_rooms %}
                    <li>
                        <input type="checkbox" name="camere" value="{{ camera.id }}">
                        {{ camera.nome }} - {{ camera.numero_posti_letto }} posti letto - {{ camera.prezzo_per_notte }}â‚¬/notte
                    </li>
                {% endfor %}
            </ul>
            <button type="button" onclick="confermaPrenotazione()">Conferma Prenotazione</button>
        {% else %}
            <p>Nessuna camera disponibile per le date e il numero di posti letto selezionati.</p>
        {% endif %}
    </form>

    <p><a href="{% url 'search_rooms' %}">Nuova ricerca</a></p>

    <script>
        function confermaPrenotazione() {
            // Ottieni gli ID delle camere selezionate
            var camereSelezionate = [];
            $("input[name='camere']:checked").each(function() {
                camereSelezionate.push($(this).val());
            });
    
            if (camereSelezionate.length === 0) {
                alert("Seleziona almeno una camera per effettuare la prenotazione.");
                return;
            }
    
            var conferma = confirm("Confermi la prenotazione delle camere selezionate?");
            if (conferma) {
                // Invia la richiesta AJAX
                $.ajax({
                    type: "POST",
                    url: "{% url 'ajax_book_rooms' %}",
                    data: {
                        'camera_ids': camereSelezionate.join(","),
                        'check_in_date': '{{ request.GET.check_in_date }}',
                        'check_out_date': '{{ request.GET.check_out_date }}',
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            window.location.href = "{% url 'core_home' %}"; // Ritorna alla home page
                        } else {
                            alert('Errore durante la prenotazione: ' + response.message);
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>
